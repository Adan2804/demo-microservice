# VirtualService para Gateway con A/B Testing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: demo-microservice-gateway-routing
  namespace: default
  labels:
    app: demo-microservice-istio
    managed-by: argocd-rollouts
spec:
  hosts:
  - "*"
  gateways:
  - demo-microservice-gateway
  http:
  # Regla 1: A/B Testing - Tráfico con header específico va al experimento
  # Cuando hay Argo Experiment activo, usa el service del experiment
  # Cuando no hay experiment, esta regla falla gracefully y pasa a la siguiente
  - name: experiment-routing
    match:
    - headers:
        aws-cf-cd-super-svp-9f8b7a6d:
          exact: "123e4567-e89b-12d3-a456-42661417400"
    route:
    - destination:
        host: demo-microservice-experiment-experiment.default.svc.cluster.local
        port:
          number: 80
      weight: 100
    headers:
      response:
        add:
          x-routed-to: "experiment-argo"
          x-istio-routing: "ab-testing-header"
          x-experiment-status: "active"
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  
  # Regla 2: Tráfico normal va a stable (producción)
  - name: production-routing
    match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: demo-microservice-istio.default.svc.cluster.local
        subset: stable
      weight: 100
    headers:
      response:
        add:
          x-routed-to: "production-stable"
          x-istio-routing: "production"
    timeout: 30s
    retries:
      attempts: 2
      perTryTimeout: 10s

---
# VirtualService para mesh interno
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: demo-microservice-mesh-routing
  namespace: default
  labels:
    experiment-active: "true"
spec:
  hosts:
  - demo-microservice-istio.default.svc.cluster.local
  gateways:
  - mesh
  http:
  # Todo el tráfico interno va al experimento
  - match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: demo-microservice-istio.default.svc.cluster.local
        subset: experimental
      weight: 100
    headers:
      response:
        add:
          x-routed-to: "experiment-candidate"
          x-istio-routing: "mesh-config"
          x-experiment-status: "active"
    timeout: 30s
    retries:
      attempts: 2
      perTryTimeout: 10s

---
# VirtualService para rollouts (se activa cuando hay rollout)
# Usa un host diferente para evitar conflictos
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: demo-microservice-rollout
  namespace: default
  labels:
    rollout-active: "false"  # Se cambia a true cuando hay rollout activo
spec:
  hosts:
  - demo-microservice-rollout.default.svc.cluster.local
  http:
  # Canary routing para rollouts
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: demo-microservice-rollout.default.svc.cluster.local
        subset: rollout-canary
      weight: 100
    headers:
      response:
        add:
          x-routed-to: "rollout-canary"
          x-istio-routing: "canary"
  
  # Stable routing para rollouts
  - route:
    - destination:
        host: demo-microservice-rollout.default.svc.cluster.local
        subset: rollout-stable
      weight: 100
    headers:
      response:
        add:
          x-routed-to: "rollout-stable"
          x-istio-routing: "stable"